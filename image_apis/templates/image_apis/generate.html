

{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    #content{
        min-height: 100%;
    }
</style>
<div class="main-container">
    <div id="generate-sidebar">
        <button class="toggle-gen-sidebar"><i class="fa-solid fa-bars"></i></button>
        <div class="sidebar-header">
            <button href="#">Generate</button>
            <button href="#">Edit</button>
        </div>
        <div class="generate-panel">
            <div class="style-box">
                <span class="subtitle">Style</span>
                <button class="panel-btn">
                    <span>Choose Style</span>
                    <i class="fa-solid fa-angle-right"></i>
                </button>
                <div class="style-dropdown">
                    <ul class="style-list">
                        <li>
                            <img src="{% static 'img/1.webp' %}" alt="Add">
                        </li>
                        <li>
                            <img src="{% static 'img/2.webp' %}" alt="Add">
                        </li>
                        <li>
                            <img src="{% static 'img/3.webp' %}" alt="Add">
                        </li>
                        <li>
                            <img src="{% static 'img/4.webp' %}" alt="Add">
                        </li>
                        <li>
                            <img src="{% static 'img/5.webp' %}" alt="Add">
                        </li>
                        <li>
                            <img src="{% static 'img/6.webp' %}" alt="Add">
                        </li>
                    </ul>
                </div>
            </div>
            <div class="pompt-box">
                <button class="panel-btn toggle">
                    <span>Prompt</span>
                    <i class="fa-solid fa-angle-right"></i>
                    <p contenteditable="true">
                    Powerful sorceress, flowing robes and mystical staff, standing in dark and ominous forest, mysterious, detailed, high detail, fantasy portrait
                    </p>
                </button>
                <button class="panel-btn toggle">
                    <span>Negative Prompt</span>
                    <i class="fa-solid fa-angle-right"></i>
                    <p contenteditable="true">
                        What do you want to avoid?
                    </p>
                </button>
            </div>
            <div class="upload-box">
                <button class="panel-btn toggle">
                    <span>Upload image</span>
                    <i class="fa-solid fa-arrow-up-from-bracket"></i>
                    <p style="display: none;">
                        <label for="upload-img" class="upload-gen-btn">
                            <i class="fa-solid fa-arrow-up-from-bracket"></i>
                            <span>Upload an image to create variations</span>
                        </label>
                        <input type="file" name="upload-img" id="upload-img" hidden>
                    </p>
                </button>
            </div>
        </div>
    </div>
    <div id="prompt-wrapper">
        <span id="user-tokens">{{userToken}}</span>
        <input id="prompt-input" type="text" placeholder="Prompt (example: a dog wearing sunglasses)">
        <button id="generate-button" class="universal-btn"><span class="loader"></span>Generate</button>
    </div>
    <div id="image-wrapper" style="max-width: 100%; max-height: 100%;"></div>
</div>

<script>
    
    const userTokenElement = document.getElementById("user-tokens");
    const promptInput = document.getElementById("prompt-input");
    const generateButton = document.getElementById("generate-button");
    const imageWrapper = document.getElementById("image-wrapper");

    const stabilityAiGenerateUrl = "https://api.stability.ai/v2beta/stable-image/generate/core";
    const base_url = "http://localhost:8000/";

    var userToken = "{{ userToken }}";

    generateButton.onclick = () => {
        show_loading_for_redirect();
        const prompt = promptInput.value;
        if( !prompt ){
            return
        }
        const form = new FormData();
        form.append("userId", "{{ userId }}");
        form.append("prompt", prompt);
        form.append("output_format", "png");
        
        fetch(
            "{% url 'image_apis:generate-ajax' %}",
            {
                method: "POST",
                body: form,
            }
            ).then(async response => {
                if(!response.ok){
                    console.log(await response.json());
                    throw new Error("response was not okay")
                }
                return response.blob();
            }).then(blob => {
                const blobUrl = URL.createObjectURL(blob);
                const imageElement = document.createElement('img');
                imageElement.src = blobUrl;
                imageElement.style.maxWidth = "100%";
                imageElement.style.maxHeight = "100%";
                imageWrapper.innerHTML = null;
                imageWrapper.appendChild(imageElement);
                userToken--;
                userTokenElement.innerText = userToken;
                // decrease_tokens(1);
                hide_loading();
            }).catch(e => {
                console.error(e);
            });
        /*
        fetch(
            stabilityAiGenerateUrl,
            {
                method: "POST",
                body: form,
                headers: {
                    Authorization: "Bearer {{api_key}}",
                    Accept: "image/*",
                },
                validateStatus: undefined,
                responseType: "arraybuffer",
            }
            ).then(async response => {
                if(!response.ok){
                    console.log(await response.json());
                    throw new Error("response was not okay")
                }
                return response.arrayBuffer();
            }).then(data => {
                const blob = new Blob([data]);
                const blobUrl = URL.createObjectURL(blob);
                const imageElement = document.createElement('img');
                imageElement.src = blobUrl;
                imageElement.style.maxWidth = "100%";
                imageElement.style.maxHeight = "100%";
                imageWrapper.innerHTML = null;
                imageWrapper.appendChild(imageElement);
                decrease_tokens(1);
                hide_loading();
            }).catch(e => {
                console.error(e);
            });
            */
        }

        function decrease_tokens(amount) {
            const form = new FormData();
            form.append("userId", "{{userId}}");
            form.append("amount", amount);

            fetch(
            base_url + "image/decrease-tokens/",
            {
                method: "POST",
                body: form,
            }
            ).then(async response => {
                if(!response.ok){
                    throw new Error("response was not okay")
                }
                return response.json();
            }).then(data => {

                userToken = data.remainingTokens;
                userTokenElement.innerText = userToken;

            }).catch(e => {
                console.error(e);
            });
        }

</script>
        


{% endblock %}
